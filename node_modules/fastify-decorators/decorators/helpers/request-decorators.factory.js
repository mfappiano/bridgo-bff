/**
 * @license
 * Copyright Andrey Chalkin <L2jLiga@gmail.com> (https://github.com/L2jLiga). All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://github.com/L2jLiga/fastify-decorators/blob/master/LICENSE
 */
import { CREATOR, ERROR_HANDLERS, HANDLERS, HOOKS } from '../../symbols/index.js';
import { ensureHandlers, hasErrorHandlers, hasHooks } from './class-properties.js';
import { createErrorsHandler } from './create-errors-handler.js';
function parseConfig(config = '/', options = {}) {
    if (typeof config === 'string')
        return { url: config, options };
    const parsed = { options, ...config };
    return {
        ...parsed,
        options: { ...parsed.options },
    };
}
const requestHandlersCache = new WeakMap();
function getTarget(Target, request, ...rest) {
    if (requestHandlersCache.has(request))
        return requestHandlersCache.get(request);
    const target = new Target(request, ...rest);
    requestHandlersCache.set(request, target);
    return target;
}
export function requestDecoratorsFactory(method) {
    return function (routeOrConfig, options) {
        const config = parseConfig(routeOrConfig, options);
        return function (target, propKey) {
            if (propKey) {
                controllerMethodDecoratorsFactory(method, config, target, propKey);
                return;
            }
            target[CREATOR] = {
                register: (instance) => {
                    if (hasHooks(target)) {
                        for (const hook of target[HOOKS]) {
                            const hookFn = (request, ...rest) => {
                                return getTarget(target, request, ...rest)[hook.handlerName](request, ...rest);
                            };
                            const option = config.options[hook.name];
                            if (option == null)
                                config.options[hook.name] = hookFn;
                            else if (Array.isArray(option))
                                option.push(hookFn);
                            else
                                config.options[hook.name] = [option, hookFn];
                        }
                    }
                    if (hasErrorHandlers(target)) {
                        config.options.errorHandler = (error, request, ...rest) => {
                            const errorsHandler = createErrorsHandler(target[ERROR_HANDLERS], getTarget(target, request, ...rest));
                            return errorsHandler(error, request, ...rest);
                        };
                    }
                    instance[method](config.url, config.options, function (request, ...rest) {
                        return getTarget(target, request, ...rest).handle();
                    });
                },
            };
        };
    };
}
export function controllerMethodDecoratorsFactory(method, config, { constructor }, propKey) {
    ensureHandlers(constructor);
    constructor[HANDLERS].push({
        url: config.url,
        method,
        options: config.options,
        handlerMethod: propKey,
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC1kZWNvcmF0b3JzLmZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9saWIvZGVjb3JhdG9ycy9oZWxwZXJzL3JlcXVlc3QtZGVjb3JhdG9ycy5mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7R0FNRztBQU1ILE9BQU8sRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNsRixPQUFPLEVBQUUsY0FBYyxFQUFFLGdCQUFnQixFQUFFLFFBQVEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ25GLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBSWpFLFNBQVMsV0FBVyxDQUFDLFNBQStCLEdBQUcsRUFBRSxVQUFpQyxFQUFFO0lBQzFGLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUTtRQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDO0lBRWhFLE1BQU0sTUFBTSxHQUFHLEVBQUUsT0FBTyxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUM7SUFDdEMsT0FBTztRQUNMLEdBQUcsTUFBTTtRQUNULE9BQU8sRUFBRSxFQUFFLEdBQUcsTUFBTSxDQUFDLE9BQU8sRUFBRTtLQUMvQixDQUFDO0FBQ0osQ0FBQztBQUVELE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxPQUFPLEVBQWtDLENBQUM7QUFFM0UsU0FBUyxTQUFTLENBQUMsTUFBVyxFQUFFLE9BQXVCLEVBQUUsR0FBRyxJQUFlO0lBQ3pFLElBQUksb0JBQW9CLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUFFLE9BQU8sb0JBQW9CLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hGLE1BQU0sTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQzVD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QU0sQ0FBQyxPQUFPO1FBQ3ZCLGFBQWEsRUFBRSxPQUFPO0tBQ3ZCLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgQW5kcmV5IENoYWxraW4gPEwyakxpZ2FAZ21haWwuY29tPiAoaHR0cHM6Ly9naXRodWIuY29tL0wyakxpZ2EpLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9MMmpMaWdhL2Zhc3RpZnktZGVjb3JhdG9ycy9ibG9iL21hc3Rlci9MSUNFTlNFXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBGYXN0aWZ5SW5zdGFuY2UsIEZhc3RpZnlSZXF1ZXN0LCBSb3V0ZVNob3J0aGFuZE9wdGlvbnMgfSBmcm9tICdmYXN0aWZ5JztcbmltcG9ydCB7IEh0dHBNZXRob2RzIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9odHRwLW1ldGhvZHMuanMnO1xuaW1wb3J0IHsgUmVxdWVzdEhhbmRsZXIsIFJlcXVlc3RIb29rIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9yZXF1ZXN0LWhhbmRsZXIuanMnO1xuaW1wb3J0IHsgUm91dGVDb25maWcgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3JvdXRlLWNvbmZpZy5qcyc7XG5pbXBvcnQgeyBDUkVBVE9SLCBFUlJPUl9IQU5ETEVSUywgSEFORExFUlMsIEhPT0tTIH0gZnJvbSAnLi4vLi4vc3ltYm9scy9pbmRleC5qcyc7XG5pbXBvcnQgeyBlbnN1cmVIYW5kbGVycywgaGFzRXJyb3JIYW5kbGVycywgaGFzSG9va3MgfSBmcm9tICcuL2NsYXNzLXByb3BlcnRpZXMuanMnO1xuaW1wb3J0IHsgY3JlYXRlRXJyb3JzSGFuZGxlciB9IGZyb20gJy4vY3JlYXRlLWVycm9ycy1oYW5kbGVyLmpzJztcblxudHlwZSBQYXJzZWRSb3V0ZUNvbmZpZyA9IHsgdXJsOiBzdHJpbmc7IG9wdGlvbnM6IFJvdXRlU2hvcnRoYW5kT3B0aW9ucyB9O1xuXG5mdW5jdGlvbiBwYXJzZUNvbmZpZyhjb25maWc6IHN0cmluZyB8IFJvdXRlQ29uZmlnID0gJy8nLCBvcHRpb25zOiBSb3V0ZVNob3J0aGFuZE9wdGlvbnMgPSB7fSk6IFBhcnNlZFJvdXRlQ29uZmlnIHtcbiAgaWYgKHR5cGVvZiBjb25maWcgPT09ICdzdHJpbmcnKSByZXR1cm4geyB1cmw6IGNvbmZpZywgb3B0aW9ucyB9O1xuXG4gIGNvbnN0IHBhcnNlZCA9IHsgb3B0aW9ucywgLi4uY29uZmlnIH07XG4gIHJldHVybiB7XG4gICAgLi4ucGFyc2VkLFxuICAgIG9wdGlvbnM6IHsgLi4ucGFyc2VkLm9wdGlvbnMgfSxcbiAgfTtcbn1cblxuY29uc3QgcmVxdWVzdEhhbmRsZXJzQ2FjaGUgPSBuZXcgV2Vha01hcDxGYXN0aWZ5UmVxdWVzdCwgUmVxdWVzdEhhbmRsZXI+KCk7XG5cbmZ1bmN0aW9uIGdldFRhcmdldChUYXJnZXQ6IGFueSwgcmVxdWVzdDogRmFzdGlmeVJlcXVlc3QsIC4uLnJlc3Q6IHVua25vd25bXSkge1xuICBpZiAocmVxdWVzdEhhbmRsZXJzQ2FjaGUuaGFzKHJlcXVlc3QpKSByZXR1cm4gcmVxdWVzdEhhbmRsZXJzQ2FjaGUuZ2V0KHJlcXVlc3QpO1xuICBjb25zdCB0YXJnZXQgPSBuZXcgVGFyZ2V0KHJlcXVlc3QsIC4uLnJlc3QpO1xuICByZXF1ZXN0SGFuZGxlcnNDYWNoZS5zZXQocmVxdWVzdCwgdGFyZ2V0KTtcbiAgcmV0dXJuIHRhcmdldDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlcXVlc3REZWNvcmF0b3JzRmFjdG9yeShcbiAgbWV0aG9kOiBIdHRwTWV0aG9kcyxcbik6IChyb3V0ZU9yQ29uZmlnPzogc3RyaW5nIHwgUm91dGVDb25maWcsIG9wdGlvbnM/OiBSb3V0ZVNob3J0aGFuZE9wdGlvbnMpID0+ICh0YXJnZXQ6IGFueSwgcHJvcEtleT86IHN0cmluZyB8IHN5bWJvbCkgPT4gdm9pZCB7XG4gIHJldHVybiBmdW5jdGlvbiAocm91dGVPckNvbmZpZz86IHN0cmluZyB8IFJvdXRlQ29uZmlnLCBvcHRpb25zPzogUm91dGVTaG9ydGhhbmRPcHRpb25zKTogKHRhcmdldDogYW55LCBwcm9wS2V5Pzogc3RyaW5nIHwgc3ltYm9sKSA9PiB2b2lkIHtcbiAgICBjb25zdCBjb25maWcgPSBwYXJzZUNvbmZpZyhyb3V0ZU9yQ29uZmlnLCBvcHRpb25zKTtcblxuICAgIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0OiBhbnksIHByb3BLZXk/OiBzdHJpbmcgfCBzeW1ib2wpOiB2b2lkIHtcbiAgICAgIGlmIChwcm9wS2V5KSB7XG4gICAgICAgIGNvbnRyb2xsZXJNZXRob2REZWNvcmF0b3JzRmFjdG9yeShtZXRob2QsIGNvbmZpZywgdGFyZ2V0LCBwcm9wS2V5KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0YXJnZXRbQ1JFQVRPUl0gPSB7XG4gICAgICAgIHJlZ2lzdGVyOiAoaW5zdGFuY2U6IEZhc3RpZnlJbnN0YW5jZSkgPT4ge1xuICAgICAgICAgIGlmIChoYXNIb29rcyh0YXJnZXQpKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGhvb2sgb2YgdGFyZ2V0W0hPT0tTXSBhcyBSZXF1ZXN0SG9va1tdKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGhvb2tGbiA9IChyZXF1ZXN0OiBGYXN0aWZ5UmVxdWVzdCwgLi4ucmVzdDogdW5rbm93bltdKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGdldFRhcmdldCh0YXJnZXQsIHJlcXVlc3QsIC4uLnJlc3QpW2hvb2suaGFuZGxlck5hbWVdKHJlcXVlc3QsIC4uLnJlc3QpO1xuICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IGNvbmZpZy5vcHRpb25zW2hvb2submFtZV07XG4gICAgICAgICAgICAgIGlmIChvcHRpb24gPT0gbnVsbCkgY29uZmlnLm9wdGlvbnNbaG9vay5uYW1lXSA9IGhvb2tGbjtcbiAgICAgICAgICAgICAgZWxzZSBpZiAoQXJyYXkuaXNBcnJheShvcHRpb24pKSBvcHRpb24ucHVzaChob29rRm4pO1xuICAgICAgICAgICAgICBlbHNlIGNvbmZpZy5vcHRpb25zW2hvb2submFtZV0gPSBbb3B0aW9uIGFzICguLi5hcmdzOiB1bmtub3duW10pID0+IHZvaWQsIGhvb2tGbl07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChoYXNFcnJvckhhbmRsZXJzKHRhcmdldCkpIHtcbiAgICAgICAgICAgIGNvbmZpZy5vcHRpb25zLmVycm9ySGFuZGxlciA9IChlcnJvciwgcmVxdWVzdCwgLi4ucmVzdCkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBlcnJvcnNIYW5kbGVyID0gY3JlYXRlRXJyb3JzSGFuZGxlcih0YXJnZXRbRVJST1JfSEFORExFUlNdLCBnZXRUYXJnZXQodGFyZ2V0LCByZXF1ZXN0LCAuLi5yZXN0KSk7XG5cbiAgICAgICAgICAgICAgcmV0dXJuIGVycm9yc0hhbmRsZXIoZXJyb3IsIHJlcXVlc3QsIC4uLnJlc3QpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaW5zdGFuY2VbbWV0aG9kXShjb25maWcudXJsLCBjb25maWcub3B0aW9ucywgZnVuY3Rpb24gKHJlcXVlc3QsIC4uLnJlc3QpIHtcbiAgICAgICAgICAgIHJldHVybiBnZXRUYXJnZXQodGFyZ2V0LCByZXF1ZXN0LCAuLi5yZXN0KS5oYW5kbGUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfTtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnRyb2xsZXJNZXRob2REZWNvcmF0b3JzRmFjdG9yeShtZXRob2Q6IEh0dHBNZXRob2RzLCBjb25maWc6IFBhcnNlZFJvdXRlQ29uZmlnLCB7IGNvbnN0cnVjdG9yIH06IGFueSwgcHJvcEtleTogc3RyaW5nIHwgc3ltYm9sKTogdm9pZCB7XG4gIGVuc3VyZUhhbmRsZXJzKGNvbnN0cnVjdG9yKTtcblxuICBjb25zdHJ1Y3RvcltIQU5ETEVSU10ucHVzaCh7XG4gICAgdXJsOiBjb25maWcudXJsLFxuICAgIG1ldGhvZCxcbiAgICBvcHRpb25zOiBjb25maWcub3B0aW9ucyxcbiAgICBoYW5kbGVyTWV0aG9kOiBwcm9wS2V5LFxuICB9KTtcbn1cbiJdfQ==
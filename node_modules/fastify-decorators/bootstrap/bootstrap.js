/**
 * @license
 * Copyright Andrey Chalkin <L2jLiga@gmail.com> (https://github.com/L2jLiga). All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://github.com/L2jLiga/fastify-decorators/blob/master/LICENSE
 */
import fp from 'fastify-plugin';
import { lstatSync, readdirSync } from 'fs';
import { fileURLToPath, URL } from 'url';
import { classLoaderFactory } from '../decorators/helpers/inject-dependencies.js';
import { readyMap } from '../decorators/index.js';
import { _injectablesHolder } from '../registry/_injectables-holder.js';
import { destructors } from '../registry/destructors.js';
import { CLASS_LOADER, CREATOR, FastifyInstanceToken } from '../symbols/index.js';
const defaultMask = /\.(handler|controller)\./;
export const bootstrap = fp(async (fastify, config) => {
    var _a;
    _injectablesHolder.injectSingleton(FastifyInstanceToken, fastify, false);
    const controllers = new Set();
    const skipBroken = config.skipBroken;
    if ('directory' in config)
        (await autoLoadModules(config)).forEach(controllers.add, controllers);
    if ('controllers' in config)
        config.controllers.forEach(controllers.add, controllers);
    const classLoader = (_a = config.classLoader) !== null && _a !== void 0 ? _a : classLoaderFactory(_injectablesHolder);
    fastify.decorate(CLASS_LOADER, classLoader);
    await loadControllers({ controllers: [...controllers], skipBroken, prefix: config.prefix }, fastify);
    await Promise.all(readyMap.values());
    if (destructors.size)
        useGracefulShutdown(fastify);
}, {
    fastify: '^3.0.0 || ^4.0.0 || ^5.0.0',
    name: 'fastifyDecorators',
});
function autoLoadModules(config) {
    const flags = config.mask instanceof RegExp ? config.mask.flags.replace('g', '') : '';
    const filter = config.mask ? new RegExp(config.mask, flags) : defaultMask;
    return Promise.all([...findModules(parseDirectory(config.directory), filter)].map(loadModule));
}
function parseDirectory(directory) {
    const urlLike = directory.toString('utf8');
    const url = urlLike.startsWith('file://') ? new URL(urlLike) : new URL('file://' + urlLike);
    if (lstatSync(url).isFile())
        url.pathname += './..';
    return url;
}
function* findModules(rootDirUrl, filter) {
    const directoriesToRead = new Set([rootDirUrl]);
    for (const dirPath of directoriesToRead) {
        for (const filePath of readdirSync(dirPath, { withFileTypes: true })) {
            const fullFilePath = new URL(`./${filePath.name}`, dirPath.href + '/');
            if (filePath.isDirectory()) {
                fullFilePath.href += '/';
                directoriesToRead.add(fullFilePath);
            }
            else if (filter.test(filePath.name)) {
                yield fullFilePath;
            }
        }
    }
}
/* istanbul ignore next */
async function loadModule(moduleUrl) {
    if (typeof require !== 'undefined') {
        const module = fileURLToPath(moduleUrl);
        // eslint-disable-next-line @typescript-eslint/no-var-requires
        return require(module).__esModule ? require(module).default : require(module);
    }
    return import(moduleUrl.toString()).then((m) => m.default);
}
async function loadControllers(config, fastify) {
    await Promise.all(config.controllers.map((controller) => loadController(controller, fastify, config)));
}
function loadController(controller, fastify, config) {
    if (verifyController(controller)) {
        return controller[CREATOR].register(fastify, config.prefix);
    }
    else if (!config.skipBroken) {
        throw new TypeError(`Loaded file is incorrect module and can not be bootstrapped: ${controller}`);
    }
}
function verifyController(controller) {
    return controller && CREATOR in controller;
}
function useGracefulShutdown(fastify) {
    fastify.addHook('onClose', () => {
        return Promise.all([...destructors].map(([Service, property]) => fastify[CLASS_LOADER](Service)[property]()));
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9vdHN0cmFwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2Jvb3RzdHJhcC9ib290c3RyYXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBR0gsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEMsT0FBTyxFQUFFLFNBQVMsRUFBWSxXQUFXLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDdEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxHQUFHLEVBQUUsTUFBTSxLQUFLLENBQUM7QUFDekMsT0FBTyxFQUFFLGtCQUFrQixFQUFlLE1BQU0sOENBQThDLENBQUM7QUFDL0YsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBR2xELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRWxGLE1BQU0sV0FBVyxHQUFHLDBCQUEwQixDQUFDO0FBUS9DLE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBd0MsRUFBRSxDQUM5RCxLQUFLLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFOztJQUN4QixrQkFBa0IsQ0FBQyxlQUFlLENBQUMsb0JBQW9CLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3pFLE1BQU0sV0FBVyxHQUFHLElBQUksR0FBRyxFQUF3QixDQUFDO0lBQ3BELE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7SUFFckMsSUFBSSxXQUFXLElBQUksTUFBTTtRQUFFLENBQUMsTUFBTSxlQUFlLENBQUMsTUFBd0IsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDbkgsSUFB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QUUsQ0FBQyxDQUFDO0tBQ25HO0FBQ0gsQ0FBQztBQUVELFNBQVMsZ0JBQWdCLENBQUMsVUFBZ0M7SUFDeEQsT0FBTyxVQUFVLElBQUksT0FBTyxJQUFJLFVBQVUsQ0FBQztBQUM3QyxDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxPQUF3QjtJQUNuRCxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUU7UUFDOUIsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFpQixPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNoSSxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgQW5kcmV5IENoYWxraW4gPEwyakxpZ2FAZ21haWwuY29tPiAoaHR0cHM6Ly9naXRodWIuY29tL0wyakxpZ2EpLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9MMmpMaWdhL2Zhc3RpZnktZGVjb3JhdG9ycy9ibG9iL21hc3Rlci9MSUNFTlNFXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBGYXN0aWZ5SW5zdGFuY2UsIEZhc3RpZnlQbHVnaW5Bc3luYyB9IGZyb20gJ2Zhc3RpZnknO1xuaW1wb3J0IGZwIGZyb20gJ2Zhc3RpZnktcGx1Z2luJztcbmltcG9ydCB7IGxzdGF0U3luYywgUGF0aExpa2UsIHJlYWRkaXJTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgZmlsZVVSTFRvUGF0aCwgVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IGNsYXNzTG9hZGVyRmFjdG9yeSwgQ29uc3RydWN0b3IgfSBmcm9tICcuLi9kZWNvcmF0b3JzL2hlbHBlcnMvaW5qZWN0LWRlcGVuZGVuY2llcy5qcyc7XG5pbXBvcnQgeyByZWFkeU1hcCB9IGZyb20gJy4uL2RlY29yYXRvcnMvaW5kZXguanMnO1xuaW1wb3J0IHR5cGUgeyBBdXRvTG9hZENvbmZpZywgQ2xhc3NMb2FkZXIsIENvbnRyb2xsZXJzTGlzdENvbmZpZyB9IGZyb20gJy4uL2ludGVyZmFjZXMvYm9vdHN0cmFwLWNvbmZpZy5qcyc7XG5pbXBvcnQgdHlwZSB7IEJvb3RzdHJhcENvbmZpZywgSW5qZWN0YWJsZUNvbnRyb2xsZXIgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2luZGV4LmpzJztcbmltcG9ydCB7IF9pbmplY3RhYmxlc0hvbGRlciB9IGZyb20gJy4uL3JlZ2lzdHJ5L19pbmplY3RhYmxlcy1ob2xkZXIuanMnO1xuaW1wb3J0IHsgZGVzdHJ1Y3RvcnMgfSBmcm9tICcuLi9yZWdpc3RyeS9kZXN0cnVjdG9ycy5qcyc7XG5pbXBvcnQgeyBDTEFTU19MT0FERVIsIENSRUFUT1IsIEZhc3RpZnlJbnN0YW5jZVRva2VuIH0gZnJvbSAnLi4vc3ltYm9scy9pbmRleC5qcyc7XG5cbmNvbnN0IGRlZmF1bHRNYXNrID0gL1xcLihoYW5kbGVyfGNvbnRyb2xsZXIpXFwuLztcblxuZGVjbGFyZSBtb2R1bGUgJ2Zhc3RpZnknIHtcbiAgaW50ZXJmYWNlIEZhc3RpZnlJbnN0YW5jZSB7XG4gICAgW0NMQVNTX0xPQURFUl06IENsYXNzTG9hZGVyO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBib290c3RyYXA6IEZhc3RpZnlQbHVnaW5Bc3luYzxCb290c3RyYXBDb25maWc+ID0gZnA8Qm9vdHN0cmFwQ29uZmlnPihcbiAgYXN5bmMgKGZhc3RpZnksIGNvbmZpZykgPT4ge1xuICAgIF9pbmplY3RhYmxlc0hvbGRlci5pbmplY3RTaW5nbGV0b24oRmFzdGlmeUluc3RhbmNlVG9rZW4sIGZhc3RpZnksIGZhbHNlKTtcbiAgICBjb25zdCBjb250cm9sbGVycyA9IG5ldyBTZXQ8Q29uc3RydWN0b3I8dW5rbm93bj4+KCk7XG4gICAgY29uc3Qgc2tpcEJyb2tlbiA9IGNvbmZpZy5za2lwQnJva2VuO1xuXG4gICAgaWYgKCdkaXJlY3RvcnknIGluIGNvbmZpZykgKGF3YWl0IGF1dG9Mb2FkTW9kdWxlcyhjb25maWcgYXMgQXV0b0xvYWRDb25maWcpKS5mb3JFYWNoKGNvbnRyb2xsZXJzLmFkZCwgY29udHJvbGxlcnMpO1xuICAgIGlmICgnY29udHJvbGxlcnMnIGluIGNvbmZpZykgY29uZmlnLmNvbnRyb2xsZXJzLmZvckVhY2goY29udHJvbGxlcnMuYWRkLCBjb250cm9sbGVycyk7XG5cbiAgICBjb25zdCBjbGFzc0xvYWRlcjogQ2xhc3NMb2FkZXIgPSBjb25maWcuY2xhc3NMb2FkZXIgPz8gY2xhc3NMb2FkZXJGYWN0b3J5KF9pbmplY3RhYmxlc0hvbGRlcik7XG4gICAgZmFzdGlmeS5kZWNvcmF0ZShDTEFTU19MT0FERVIsIGNsYXNzTG9hZGVyKTtcblxuICAgIGF3YWl0IGxvYWRDb250cm9sbGVycyh7IGNvbnRyb2xsZXJzOiBbLi4uY29udHJvbGxlcnNdLCBza2lwQnJva2VuLCBwcmVmaXg6IGNvbmZpZy5wcmVmaXggfSwgZmFzdGlmeSk7XG4gICAgYXdhaXQgUHJvbWlzZS5hbGwocmVhZHlNYXAudmFsdWVzKCkpO1xuXG4gICAgaWYgKGRlc3RydWN0b3JzLnNpemUpIHVzZUdyYWNlZnVsU2h1dGRvd24oZmFzdGlmeSk7XG4gIH0sXG4gIHtcbiAgICBmYXN0aWZ5OiAnXjMuMC4wIHx8IF40LjAuMCB8fCBeNS4wLjAnLFxuICAgIG5hbWU6ICdmYXN0aWZ5RGVjb3JhdG9ycycsXG4gIH0sXG4pO1xuXG5mdW5jdGlvbiBhdXRvTG9hZE1vZHVsZXMoY29uZmlnOiBBdXRvTG9hZENvbmZpZyk6IFByb21pc2U8SW5qZWN0YWJsZUNvbnRyb2xsZXJbXT4ge1xuICBjb25zdCBmbGFncyA9IGNvbmZpZy5tYXNrIGluc3RhbmNlb2YgUmVnRXhwID8gY29uZmlnLm1hc2suZmxhZ3MucmVwbGFjZSgnZycsICcnKSA6ICcnO1xuICBjb25zdCBmaWx0ZXIgPSBjb25maWcubWFzayA/IG5ldyBSZWdFeHAoY29uZmlnLm1hc2ssIGZsYWdzKSA6IGRlZmF1bHRNYXNrO1xuXG4gIHJldHVybiBQcm9taXNlLmFsbChbLi4uZmluZE1vZHVsZXMocGFyc2VEaXJlY3RvcnkoY29uZmlnLmRpcmVjdG9yeSksIGZpbHRlcildLm1hcChsb2FkTW9kdWxlKSk7XG59XG5cbmZ1bmN0aW9uIHBhcnNlRGlyZWN0b3J5KGRpcmVjdG9yeTogUGF0aExpa2UpOiBVUkwge1xuICBjb25zdCB1cmxMaWtlID0gZGlyZWN0b3J5LnRvU3RyaW5nKCd1dGY4Jyk7XG4gIGNvbnN0IHVybCA9IHVybExpa2Uuc3RhcnRzV2l0aCgnZmlsZTovLycpID8gbmV3IFVSTCh1cmxMaWtlKSA6IG5ldyBVUkwoJ2ZpbGU6Ly8nICsgdXJsTGlrZSk7XG5cbiAgaWYgKGxzdGF0U3luYyh1cmwpLmlzRmlsZSgpKSB1cmwucGF0aG5hbWUgKz0gJy4vLi4nO1xuICByZXR1cm4gdXJsO1xufVxuXG5mdW5jdGlvbiogZmluZE1vZHVsZXMocm9vdERpclVybDogVVJMLCBmaWx0ZXI6IFJlZ0V4cCk6IEl0ZXJhYmxlPFVSTD4ge1xuICBjb25zdCBkaXJlY3Rvcmllc1RvUmVhZCA9IG5ldyBTZXQ8VVJMPihbcm9vdERpclVybF0pO1xuXG4gIGZvciAoY29uc3QgZGlyUGF0aCBvZiBkaXJlY3Rvcmllc1RvUmVhZCkge1xuICAgIGZvciAoY29uc3QgZmlsZVBhdGggb2YgcmVhZGRpclN5bmMoZGlyUGF0aCwgeyB3aXRoRmlsZVR5cGVzOiB0cnVlIH0pKSB7XG4gICAgICBjb25zdCBmdWxsRmlsZVBhdGggPSBuZXcgVVJMKGAuLyR7ZmlsZVBhdGgubmFtZX1gLCBkaXJQYXRoLmhyZWYgKyAnLycpO1xuXG4gICAgICBpZiAoZmlsZVBhdGguaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICBmdWxsRmlsZVBhdGguaHJlZiArPSAnLyc7XG4gICAgICAgIGRpcmVjdG9yaWVzVG9SZWFkLmFkZChmdWxsRmlsZVBhdGgpO1xuICAgICAgfSBlbHNlIGlmIChmaWx0ZXIudGVzdChmaWxlUGF0aC5uYW1lKSkge1xuICAgICAgICB5aWVsZCBmdWxsRmlsZVBhdGg7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG5hc3luYyBmdW5jdGlvbiBsb2FkTW9kdWxlKG1vZHVsZVVybDogVVJMKTogUHJvbWlzZTxJbmplY3RhYmxlQ29udHJvbGxlcj4ge1xuICBpZiAodHlwZW9mIHJlcXVpcmUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgY29uc3QgbW9kdWxlID0gZmlsZVVSTFRvUGF0aChtb2R1bGVVcmwpO1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdmFyLXJlcXVpcmVzXG4gICAgcmV0dXJuIHJlcXVpcmUobW9kdWxlKS5fX2VzTW9kdWxlID8gcmVxdWlyZShtb2R1bGUpLmRlZmF1bHQgOiByZXF1aXJlKG1vZHVsZSk7XG4gIH1cblxuICByZXR1cm4gaW1wb3J0KG1vZHVsZVVybC50b1N0cmluZygpKS50aGVuKChtKSA9PiBtLmRlZmF1bHQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBsb2FkQ29udHJvbGxlcnMoY29uZmlnOiBDb250cm9sbGVyc0xpc3RDb25maWcsIGZhc3RpZnk6IEZhc3RpZnlJbnN0YW5jZSk6IFByb21pc2U8dm9pZD4ge1xuICBhd2FpdCBQcm9taXNlLmFsbChjb25maWcuY29udHJvbGxlcnMubWFwKChjb250cm9sbGVyKSA9PiBsb2FkQ29udHJvbGxlcihjb250cm9sbGVyLCBmYXN0aWZ5LCBjb25maWcpKSk7XG59XG5cbmZ1bmN0aW9uIGxvYWRDb250cm9sbGVyKGNvbnRyb2xsZXI6IENvbnN0cnVjdG9yPHVua25vd24+LCBmYXN0aWZ5OiBGYXN0aWZ5SW5zdGFuY2UsIGNvbmZpZzogQm9vdHN0cmFwQ29uZmlnKSB7XG4gIGlmICh2ZXJpZnlDb250cm9sbGVyKGNvbnRyb2xsZXIpKSB7XG4gICAgcmV0dXJuIGNvbnRyb2xsZXJbQ1JFQVRPUl0ucmVnaXN0ZXIoZmFzdGlmeSwgY29uZmlnLnByZWZpeCk7XG4gIH0gZWxzZSBpZiAoIWNvbmZpZy5za2lwQnJva2VuKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgTG9hZGVkIGZpbGUgaXMgaW5jb3JyZWN0IG1vZHVsZSBhbmQgY2FuIG5vdCBiZSBib290c3RyYXBwZWQ6ICR7Y29udHJvbGxlcn1gKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB2ZXJpZnlDb250cm9sbGVyKGNvbnRyb2xsZXI6IENvbnN0cnVjdG9yPHVua25vd24+KTogY29udHJvbGxlciBpcyBJbmplY3RhYmxlQ29udHJvbGxlciB7XG4gIHJldHVybiBjb250cm9sbGVyICYmIENSRUFUT1IgaW4gY29udHJvbGxlcjtcbn1cblxuZnVuY3Rpb24gdXNlR3JhY2VmdWxTaHV0ZG93bihmYXN0aWZ5OiBGYXN0aWZ5SW5zdGFuY2UpOiB2b2lkIHtcbiAgZmFzdGlmeS5hZGRIb29rKCdvbkNsb3NlJywgKCkgPT4ge1xuICAgIHJldHVybiBQcm9taXNlLmFsbChbLi4uZGVzdHJ1Y3RvcnNdLm1hcCgoW1NlcnZpY2UsIHByb3BlcnR5XSkgPT4gZmFzdGlmeVtDTEFTU19MT0FERVJdPHR5cGVvZiBTZXJ2aWNlPihTZXJ2aWNlKVtwcm9wZXJ0eV0oKSkpO1xuICB9KTtcbn1cbiJdfQ==